# Cursor Prompt: Build a Go CLI pentest helper for Omnidocs **NewgenONE** integrations

You are Cursor. Generate **production‑grade Go code** for a CLI tool that helps a licensed pentester discover **misconfigurations and vulnerabilities** in Omnidocs NewgenONE deployments. The tool must run unauthenticated and authenticated checks, and it must be easy to extend.

**Project name (binary):** `newgenone-pentest`

**Default cabinet name:** `newgenso` (configurable via flag)

---

## High‑level objectives
1. **Discover & map** unauthenticated surface (health/version/docs endpoints, static assets, open directories, API schemas).
2. **Authenticate** with username/password (prompt or flags), persist cookies/JWT, and run **authenticated** checks.
3. **Detect common web/API misconfigs** (headers, CORS, CSRF, rate limiting, session, JWT, TLS, IDOR/BOLA, access control, file upload/download issues, sensitive info exposure, default creds, debug endpoints, open API docs, SSRF-ish importers, etc.).
4. **Report clearly**: console table + JSON + optional SARIF/JUnit outputs. Severity categorization: `INFO/LOW/MED/HIGH/CRITICAL`.
5. **Extensible architecture**: simple plugin/registry pattern for adding new checks without touching core.

> ⚠️ The tool must **not** attempt destructive actions by default. Provide a `--dangerous` flag to unlock tests that could modify state (e.g., upload/delete). All tests respect `--rate-limit` and timeouts.

---

## CLI & configuration
Implement with `cobra` + `viper` (or clean stdlib flags; cobra preferred).

### Required flags / inputs
- `--base-url` (string, required) e.g. `https://newgen.example.com`
- `--cabinet` (string, default: `newgenso`)
- `--username` (string) — if omitted, prompt securely
- `--password` (string) — if omitted, prompt securely (no echo)
- `--auth` (bool, default: true) — run authenticated checks
- `--unauth` (bool, default: true) — run unauthenticated checks
- `--include` (string, repeatable) — extra paths to include
- `--exclude` (string, repeatable) — glob/regex to skip
- `--timeout` (duration, default: 10s)
- `--concurrency` (int, default: 10)
- `--rate-limit` (rps, float, default: 5.0)
- `--proxy` (string, http(s):// or socks5://)
- `--insecure-tls` (bool) — skip TLS verify
- `--output-json` (path) — write machine‑readable results
- `--output-sarif` (path) — optional SARIF 2.1.0 for CI
- `--output-junit` (path) — optional JUnit XML
- `--dangerous` (bool) — enable state‑changing tests (e.g. upload)
- `--max-ids` (int, default: small) — IDOR probing cap to avoid heavy enumeration

Also support env vars: `NEWGEN_BASE_URL`, `NEWGEN_USER`, `NEWGEN_PASS`, etc.

### UX niceties
- Pretty table output (go‑pretty) and JSON log stream.
- Colorized severities. Quiet mode `-q` and verbose `-v`.
- Respect `HTTP_PROXY/HTTPS_PROXY/NO_PROXY`.

---

## Auth flows
Implement a pluggable `Authenticator` interface:
```go
type Authenticator interface {
    Login(ctx context.Context, c *http.Client, baseURL, user, pass string) (*Session, error)
    Name() string
}
```

Provide **at least two** authenticators:
1. **FormSessionAuth**: POST credentials to a login form endpoint (discover common paths: `/login`, `/auth/login`, `/api/auth/login`). Capture session cookie names dynamically. Follow redirects.
2. **JWTAuth**: JSON login endpoint (e.g., `/api/auth/login`) returning a bearer token. Persist in `http.RoundTripper` and refresh if 401.

Store into a `Session` struct with:
- Cookies (cookiejar)
- Optional JWT + expiry
- CSRF token discovery (scrape hidden fields or header on first 200 from app)

> Do **not** write credentials to disk. Keep only in memory.

---

## HTTP client & resilience
- Use a single `http.Client` with:
  - `cookiejar`
  - Optional proxy
  - TLS skip verify toggle
  - Custom transport adding headers (User‑Agent `newgenone-pentest/<version>`) and rate‑limit (token bucket)
- Robust redirect handling (capture new cookies/locations).
- Context timeouts and sane retries (idempotent GET/HEAD/OPTIONS only). Exponential backoff.

---

## Discovery phase (unauth)
- Fetch and analyze:
  - `GET /` (headers, cookies, CSP, HSTS, X‑Frame‑Options, X‑Content‑Type‑Options, Referrer‑Policy)
  - `GET /robots.txt`, `/sitemap.xml`
  - Common API docs: `/swagger.json`, `/v3/api-docs`, `/openapi.json`, `/api-docs`, `/swagger-ui.html`
  - Health/actuators/metrics/version: `/health`, `/actuator`, `/metrics`, `/version`, `/manage`, `/status`
  - Static and potential open dirs: `/static/`, `/public/`, `/uploads/`, `/files/`, `/documents/`
- **CORS audit**: Check `Access-Control-Allow-Origin`, `Access-Control-Allow-Credentials`, preflight responses.
- **Clickjacking**: Absence/misuse of `X-Frame-Options` or `Content-Security-Policy` frame-ancestors.
- **MIME sniffing**: Check `X-Content-Type-Options: nosniff` and mismatched types.
- **Server leakage**: `Server`, `X-Powered-By`, build/version banners.
- **Open redirects**: parameters like `next`, `redirect`, `returnUrl`.
- **Unauth data access**: try lightweight probes on endpoints known to exist in DMS/ECM apps, e.g. list/search/download by ID with small ID windows. Respect `--max-ids`.

> All enumeration must be capped and stop on first sensitive hit (to reduce impact).

---

## Authenticated checks
Focus on cabinet‑scoped access (default: `newgenso`).

### Access control & IDOR/BOLA
- Attempt to access documents/folders/workflows by numeric/UUID identifiers outside the authenticated user’s scope:
  - `/api/documents/{id}`
  - `/api/folders/{id}`
  - `/api/cabinets/{cabinet}/documents/{id}`
  - `/download?docId=...&cabinet=...`
- Vary `cabinet` parameter to other values and missing values. Expect 403/404. Report 200/partial data as **HIGH** or **CRITICAL**.
- Attempt **cross‑cabinet** access if multiple cabinets are revealed (but only sample per `--max-ids`).

### CSRF
- Detect whether state‑changing endpoints (POST/PUT/PATCH/DELETE) require a CSRF token:
  - Create/rename/delete: document, folder, metadata update, workflow transition.
  - If no CSRF cookie/header/hidden field and `SameSite=None` + `CORS *` with credentials → **CRITICAL**.

### JWT/session hygiene
- Decode JWT (if used). Check:
  - Short expiration (<5m OK) vs very long (>24h warn)
  - `alg` anomalies (e.g., `none`, if accepted)
  - Weak claims (missing `aud`, `iss`), unsafely trusted roles in client‑side claims
- Cookies: `Secure`, `HttpOnly`, `SameSite` presence consistency.

### Rate limiting & lockout
- Throttle login attempts gently to test lockout indicator (configurable); ensure **no DoS**. Report lack of lockout/rate limit.
- Check **password reset** endpoints for user enumeration differences (timing/body/headers).

### File upload & download safety (enable via `--dangerous` for writes)
- Upload validation probes to publication/import endpoints (e.g., `/api/upload`, `/api/documents`):
  - Double extensions (`.jpg.php`, `.pdf.exe`), uncommon types, overlong filenames
  - Mismatched Content‑Type vs magic bytes
  - EICAR string in a text file (opt‑in) to see if AV is present (do **not** upload executable code)
- Download safety:
  - Verify `Content-Disposition` and content type
  - Path traversal in `?path=` or `?file=` params
  - URL‑based importers (potential SSRF): try `http://127.0.0.1/` or metadata fetch endpoints with **safe** non‑invasive SSRF indicators (blocked by default; allow only if `--dangerous-ssrf` is set). Use DNS canary domain **if user provides one**.

### Search & filter injection
- If OData/SQL‑like filters exist (`filter`, `where`, `q`, `orderBy`), test for injection patterns (error‑based responses, time delays with safe sleep functions if supported). Strict caps and timeouts.

### Workflow & administration
- Try to access workflow transition endpoints and admin/monitoring UIs while authenticated as a low‑priv user. Report if accessible (no CSRF/ACL).

### Security headers & TLS
- HSTS presence on HTTPS, min TLS, weak ciphers (best‑effort via stdlib; note if advanced scan needed).

---

## Extra attacks/misconfigs for Cursor to add
In addition to the above, **proactively implement** detection for:
- **CSP gaps** enabling reflected/stored XSS through document titles/metadata fields.
- **CORS wildcard** with `Access-Control-Allow-Credentials: true`.
- **Verbose errors/stack traces** (framework fingerprints).
- **Misplaced backups**: `/*.bak`, `/*.old`, `/.git/`, `/.env`, `/.DS_Store`, `/WEB-INF/`, `/admin`.
- **Swagger schema parsing**: If OpenAPI/Swagger found, parse to auto‑register checks for each operation (auth requirement, response codes, parameter fuzzing with safe payloads).
- **Pagination abuse**: oversized `pageSize`/`limit` causing heavy responses (report, do not DoS).
- **Object storage leaks**: pre‑signed URLs in JSON.
- **Open redirect**: variations across modules.

---

## Architecture & packages
```
cmd/newgenone-pentest/main.go         # cobra CLI, config wiring
internal/client/httpclient.go         # http.Client factory, rate limit, proxy, TLS, UA
internal/auth/form_auth.go            # FormSessionAuth
internal/auth/jwt_auth.go             # JWTAuth
internal/session/session.go           # Session struct, CSRF discovery
internal/discovery/unauth.go          # surface discovery
internal/checks/headers.go            # security headers/CORS
internal/checks/csrf.go               # CSRF checks
internal/checks/jwt.go                # JWT analysis
internal/checks/idor.go               # IDOR/BOLA
internal/checks/rate_limit.go         # rate/lockout
internal/checks/upload.go             # uploads (dangerous)
internal/checks/download.go           # download/path traversal
internal/checks/search_injection.go   # filter injection
internal/checks/admin_workflow.go     # admin/workflow access
internal/checks/swagger.go            # OpenAPI autodiscovery
internal/report/report.go             # struct, writers (console, JSON, SARIF, JUnit)
internal/util/html.go                 # goquery helpers
internal/util/jwt.go                  # JWT decode helpers
internal/util/rand.go                 # ID sampling helpers
```

### Core interfaces
```go
type Check interface {
    ID() string
    Severity() string // INFO/LOW/MED/HIGH/CRITICAL
    Title() string
    Run(ctx context.Context, sess *session.Session, baseURL string, cfg *Config) ([]Finding, error)
}

type Finding struct {
    CheckID   string
    Severity  string
    Title     string
    Summary   string
    Endpoint  string
    Evidence  string            // clipped bodies, headers
    Remediate string
}
```

Use a simple **registry** to add checks:
```go
var Registry = []checks.Check{ /* filled in init() of each file */ }
```

### Dependencies (suggested)
- `github.com/spf13/cobra`, `github.com/spf13/viper`
- `github.com/PuerkitoBio/goquery`
- `golang.org/x/sync/errgroup`
- `github.com/jedib0t/go-pretty/v6/table`
- `github.com/fatih/color`
- `github.com/golang-jwt/jwt/v5`

Keep everything Go 1.21+ compatible.

---

## Reporting
- **Console**: grouped by severity with compact table (`Severity | Check | Endpoint | Summary`).
- **JSON**: full payload with timestamps, config excerpt (no secrets), and request fingerprints (method, path, status). Mask cookies/tokens.
- **SARIF/JUnit**: optional outputs for CI.

Include remediation text per finding (e.g., “enforce `SameSite=Lax|Strict` on session cookie”, “deny cross‑cabinet access server‑side”).

---

## Sample run (examples)
```bash
# Unauth discovery only
newgenone-pentest --base-url https://newgen.example.com --unauth --auth=false

# Full run with cabinet and creds (prompted securely)
newgenone-pentest --base-url https://newgen.example.com --cabinet newgenso

# With explicit creds and outputs
newgenone-pentest \
  --base-url https://newgen.example.com \
  --username alice --password 'S3cret!' \
  --cabinet newgenso \
  --output-json findings.json --output-sarif findings.sarif

# Enable state‑changing tests (uploads, workflow actions)
newgenone-pentest --base-url https://newgen.example.com --dangerous
```

---

## Acceptance criteria (must‑haves)
- [ ] Prompts for username/password if not provided; does not echo input.
- [ ] Runs both unauth and auth test suites depending on flags.
- [ ] Stores session cookies/JWT securely in memory; auto‑refresh on 401.
- [ ] Discovers API docs (OpenAPI/Swagger) and, if present, enumerates endpoints.
- [ ] Performs header/CORS/CSRF/JWT/RateLimit checks.
- [ ] Performs IDOR/BOLA probes across cabinet boundary (default cabinet `newgenso`).
- [ ] Performs safe, capped unauth data access probes.
- [ ] Optional dangerous tests for upload/import/download traversal behind a flag.
- [ ] Outputs console table + JSON report; SARIF/JUnit optional.
- [ ] Extensible: adding a new check file auto‑registers via registry.
- [ ] Honors proxy, TLS, rate limit, concurrency, and timeouts.

---

## Remediation guidance per category (to include in findings)
- **CORS**: Avoid `*` with credentials; set explicit origins; preflight tightening.
- **CSRF**: Enforce CSRF tokens on state changes; set `SameSite` cookies; check Origin/Referer.
- **IDOR/BOLA**: Server‑side authz checks on every object access; avoid trusting client‑provided `cabinet`.
- **Headers**: Set `X-Frame-Options`/`frame-ancestors`, `X-Content-Type-Options`, `Referrer-Policy`, strict `CSP`.
- **JWT**: Strong `aud/iss/exp`, short TTL, key rotation, reject `none`/wrong alg.
- **Rate limiting**: Login throttling, IP/user lockout, centralized audit.
- **Uploads**: Validate by content, store outside webroot, strip active content, AV scan, signed download URLs.
- **Open redirects**: Allowlist internal paths only.

---

## Notes for Cursor
- Generate clean, commented code with clear separation of concerns.
- Provide unit tests for utility packages (JWT parse, header audit, rate limiter).
- Add `Makefile` targets: `build`, `test`, `lint`, `release`.
- Provide a minimal `README.md` with examples and legal/ethical notice (authorized use only).
- Where discovery finds new endpoints/parameters, **auto‑enqueue** safe checks using the same client/session.

---

## Legal/Ethical
This tool is for **authorized security testing** only. It should minimize load, respect rate limits, and avoid data exfiltration. State‑changing tests are disabled by default and require explicit opt‑in.

